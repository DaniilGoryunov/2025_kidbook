import requests
import urllib3
import json
import os

# Отключаем предупреждения об SSL 
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

# Функция для отправки сообщения в ГигаЧат
def send_message(access_token, label, topic):
    url = "https://gigachat.devices.sberbank.ru/api/v1/chat/completions"
    headers = {
        "Content-Type": "application/json",
        "Accept": "application/json",
        "Authorization": f"Bearer {access_token}"
    }
    # ПИСАТЬ СЮДА
    prompt = f'Привет, можешь объяснить на русском что такое "{label}". Вот тебе небольшой текст с английской википедии: "{topic}". Перепеши его, будто объясняешь это для 10 летнего ребенка (на русском) и развей мысль. Ну и не пиши "Привет" и прочие вещи, просто выведи то, что я прошу. .'
    payload = {
        "model": "GigaChat",
        "messages": [{"role": "user", "content": prompt}],
        # "temperature": temperature,
        # "top_p": top_p,
        # "max_tokens": max_tokens,
        # "n": 1  
    }

    try:
        response = requests.post(url, headers=headers, json=payload, verify=False)
        if response.status_code == 200:
            return response.json().get("choices", [{}])[0].get("message", {}).get("content", "Ответ не найден")
        else:
            return f"Ошибка {response.status_code}: {response.text}"
    except requests.RequestException as e:
        return f"Ошибка запроса: {str(e)}"

# Читаем токен из файла
with open("token.txt", "r") as file:
    access_token = file.read().strip()

# Читаем JSON-файл
with open("enriched_articles.json", "r", encoding="utf-8") as file:
    data = json.load(file)

os.makedirs("Baiden suka", exist_ok=True)

# Настройки модели 
# TEMPERATURE = 0.7  
# TOP_P = 0.9        
# MAX_TOKENS = 2000   # Ограничение длины ответа

# Обрабатываем каждый объект в JSON
for item in data:
    label = item["label"]
    topic = item["topic"]

    if topic == "not existing article":
        continue

    response_text = send_message(access_token, label, topic)

    file_name = f"Baiden suka/{label}.md"

    # Записываем ответ в .md файл
    with open(file_name, "w", encoding="utf-8") as md_file:
        md_file.write(f"# {label}\n\n{response_text}")

    print(f"Сохранён файл: {file_name}")
